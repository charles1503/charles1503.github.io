<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Docker构建Canal集群 | Charles's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Docker构建Canal集群</h1><a id="logo" href="/.">Charles's Blog</a><p class="description">任何事都没有表面看起来那么简单。</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Docker构建Canal集群</h1><div class="post-meta">Mar 13, 2019<span> | </span><span class="category"><a href="/categories/中间件/">中间件</a></span></div><a class="disqus-comment-count" href="/2019/03/13/Docker构建Canal集群/#vcomment"><span class="valine-comment-count" data-xid="/2019/03/13/Docker构建Canal集群/"></span><span> 条评论</span></a><div class="post-content"><h2 id="在MacOS上使用Docker构建Canal集群"><a href="#在MacOS上使用Docker构建Canal集群" class="headerlink" title="在MacOS上使用Docker构建Canal集群"></a>在MacOS上使用Docker构建Canal集群</h2><h3 id="Canal基本使用"><a href="#Canal基本使用" class="headerlink" title="Canal基本使用"></a><a href="https://charles1503.github.io/2019/03/12/MaxWell%E4%B8%8ECanal/" target="_blank" rel="noopener">Canal基本使用</a></h3><h3 id="集群环境"><a href="#集群环境" class="headerlink" title="集群环境"></a>集群环境</h3><ul>
<li>操作系统: MacOS 10.14.2</li>
<li>Docker版本: Server Version: 18.09.0</li>
<li>Canal版本: 1.1.2</li>
<li>Zookeeper版本: 3.4.13</li>
<li>MySQL版本: 5.6.43</li>
<li>Kafka版本: kafka_2.12-2.1.1</li>
</ul>
<h3 id="zookeeper集群"><a href="#zookeeper集群" class="headerlink" title="zookeeper集群"></a>zookeeper集群</h3><ul>
<li><p>下载zookeeper</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -O https://archive.apache.org/dist/zookeeper/stable/zookeeper-3.4.13.tar.gz</span><br></pre></td></tr></table></figure>
</li>
<li><p>Dockerfile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FROM alpine/jre8</span><br><span class="line">MAINTAINER charles &quot;amwfhv@yeah.net&quot;</span><br><span class="line">RUN apk add --no-cache \</span><br><span class="line">    bash \</span><br><span class="line">    su-exec</span><br><span class="line">ADD zookeeper-3.4.13.tar.gz /</span><br><span class="line">ENTRYPOINT [&quot;/zookeeper-3.4.13/bin/zkServer.sh&quot;]</span><br><span class="line">CMD [&quot;start-foreground&quot;]</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dataDir=/zookeeper-3.4.13/data</span><br><span class="line">dataLogDir=/zookeeper-3.4.13/log</span><br><span class="line">clientPort=2181</span><br><span class="line">#集群配置</span><br><span class="line">server.1=zk1:2888:3888</span><br><span class="line">server.2=zk2:2888:3888</span><br><span class="line">server.3=zk3:2888:3888</span><br></pre></td></tr></table></figure>
</li>
<li><p>单机运行(去掉zoo.cfg中集群配置)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm -it -v `pwd`/zoo.cfg:/zookeeper-3.4.13/conf/zoo.cfg zk /bin/bash</span><br></pre></td></tr></table></figure>
</li>
<li><p>myid</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;1&quot; &gt;&gt; myid_1</span><br><span class="line">echo &quot;2&quot; &gt;&gt; myid_2</span><br><span class="line">echo &quot;3&quot; &gt;&gt; myid_3</span><br></pre></td></tr></table></figure>
</li>
<li><p>docker-compose编排</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">version: &apos;2&apos;</span><br><span class="line">services:</span><br><span class="line">  zk1:</span><br><span class="line">    build:</span><br><span class="line">      context: ./</span><br><span class="line">      dockerfile: ./Dockerfile</span><br><span class="line">    container_name: zk1</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;2181:2181&quot;</span><br><span class="line">    networks:</span><br><span class="line">      zk-cluster:  # 使用zk-cluster网络</span><br><span class="line">        ipv4_address: 192.168.111.111   #固定容器IP为192.168.111.111</span><br><span class="line">    volumes:</span><br><span class="line">      - ./zoo.cfg:/zookeeper-3.4.13/conf/zoo.cfg</span><br><span class="line">      - ./myid_1:/zookeeper-3.4.13/data/myid</span><br><span class="line">  zk2:</span><br><span class="line">    build:</span><br><span class="line">      context: ./</span><br><span class="line">      dockerfile: ./Dockerfile</span><br><span class="line">    container_name: zk2</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;2182:2181&quot;</span><br><span class="line">    networks:</span><br><span class="line">      zk-cluster:  # 使用zk-cluster网络</span><br><span class="line">        ipv4_address: 192.168.111.112   #固定容器IP为192.168.111.112</span><br><span class="line">    volumes:</span><br><span class="line">      - ./zoo.cfg:/zookeeper-3.4.13/conf/zoo.cfg</span><br><span class="line">      - ./myid_2:/zookeeper-3.4.13/data/myid</span><br><span class="line">  zk3:</span><br><span class="line">    build:</span><br><span class="line">      context: ./</span><br><span class="line">      dockerfile: ./Dockerfile</span><br><span class="line">    container_name: zk3</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;2183:2181&quot;</span><br><span class="line">    networks:</span><br><span class="line">      zk-cluster:  # 使用zk-cluster网络</span><br><span class="line">        ipv4_address: 192.168.111.113   #固定容器IP为192.168.111.113</span><br><span class="line">    volumes:</span><br><span class="line">      - ./zoo.cfg:/zookeeper-3.4.13/conf/zoo.cfg</span><br><span class="line">      - ./myid_3:/zookeeper-3.4.13/data/myid</span><br><span class="line">networks:</span><br><span class="line">  zk-cluster:</span><br><span class="line">    driver: bridge</span><br><span class="line">    #   自定义网络信息</span><br><span class="line">    ipam:</span><br><span class="line">      driver: default</span><br><span class="line">      config:</span><br><span class="line">        - subnet: 192.168.111.0/24  # 子网段</span><br><span class="line">          gateway: 192.168.111.1    # 网关</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看节点状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it 29f801542d70 /zookeeper-3.4.13/bin/zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /zookeeper-3.4.13/bin/../conf/zoo.cfg</span><br><span class="line">Mode: follower</span><br><span class="line"></span><br><span class="line">docker exec -it 2325d87530f9 /zookeeper-3.4.13/bin/zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /zookeeper-3.4.13/bin/../conf/zoo.cfg</span><br><span class="line">Mode: leader</span><br><span class="line"></span><br><span class="line">docker exec -it f5d8b209d22f /zookeeper-3.4.13/bin/zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /zookeeper-3.4.13/bin/../conf/zoo.cfg</span><br><span class="line">Mode: follower</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="MySQL-单机"><a href="#MySQL-单机" class="headerlink" title="MySQL(单机)"></a>MySQL(单机)</h3><ul>
<li><p>拉取镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql/mysql-server:5.6</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置mysql文件(<code>主要开启binlog</code>)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">vi my.cnf</span><br><span class="line"># For advice on how to change settings please see</span><br><span class="line"># http://dev.mysql.com/doc/refman/5.6/en/server-configuration-defaults.html</span><br><span class="line">[mysql]</span><br><span class="line">default-character-set=utf8mb4</span><br><span class="line">[mysqld]</span><br><span class="line">#不加 user=root会报错: Fatal error: Please read &quot;Security&quot; section of the manual to find out how to run mysqld as root!</span><br><span class="line">user=root</span><br><span class="line">port = 3306</span><br><span class="line">character_set_server=utf8mb4</span><br><span class="line">#错误日志</span><br><span class="line">log-error=/logs/error.log</span><br><span class="line">#开启慢查询日志记录</span><br><span class="line">slow_query_log=1</span><br><span class="line">#查询时间超过2秒的sql语句会被记录</span><br><span class="line">long_query_time=2</span><br><span class="line">#记录没有使用索引的查询  </span><br><span class="line">log_queries_not_using_indexes=1</span><br><span class="line">#记录慢查询日志的文件地址</span><br><span class="line">slow-query-log-file=/logs/slowquery.log</span><br><span class="line">#记录用户所有的操作</span><br><span class="line">general_log=ON</span><br><span class="line">#操作日志</span><br><span class="line">general_log_file=/logs/operation.log</span><br><span class="line">#bin Log</span><br><span class="line">#log-bin=/logs/bin-log.log</span><br><span class="line"></span><br><span class="line">###开启binlog</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line">binlog-format=ROW</span><br><span class="line">server_id=1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Remove leading # and set to the amount of RAM for the most important data</span><br><span class="line"># cache in MySQL. Start at 70% of total RAM for dedicated server, else 10%.</span><br><span class="line"># innodb_buffer_pool_size = 128M</span><br><span class="line">#</span><br><span class="line"># Remove leading # to turn on a very important data integrity option: logging</span><br><span class="line"># changes to the binary log between backups.</span><br><span class="line"># log_bin</span><br><span class="line">#</span><br><span class="line"># Remove leading # to set options mainly useful for reporting servers.</span><br><span class="line"># The server defaults are faster for transactions and fast SELECTs.</span><br><span class="line"># Adjust sizes as needed, experiment to find the optimal values.</span><br><span class="line"># join_buffer_size = 128M</span><br><span class="line"># sort_buffer_size = 2M</span><br><span class="line"># read_rnd_buffer_size = 2M</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line"></span><br><span class="line"># Disabling symbolic-links is recommended to prevent assorted security risks</span><br><span class="line">symbolic-links=0</span><br><span class="line"></span><br><span class="line"># Recommended in standard MySQL setup</span><br><span class="line">sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES</span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line">pid-file=/var/run/mysqld/mysqld.pid</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试单机运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 3306:3306 --name mysql5.6 -v `pwd`/my.cnf:/etc/my.cnf -v `pwd`/logs:/logs -v `pwd`/data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=password -d mysql/mysql-server:5.6</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试进入命令行(<code>容器ID为:897495c2b60d</code>)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it 897495c2b60d mysql -u root -p</span><br><span class="line">Enter password:</span><br><span class="line"></span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 355</span><br><span class="line">Server version: 5.6.42-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Canal"><a href="#Canal" class="headerlink" title="Canal"></a>Canal</h3><ul>
<li><p>修改conf/canal.properties</p>
<ol>
<li>增加zkServers配置,多个zk用逗号分隔    <code>canal.zkServers=zk1:2181,zk2:2181,zk3:2181</code></li>
<li>采用自行配置canal镜像,非<a href="https://github.com/alibaba/canal/wiki/Docker-QuickStart" target="_blank" rel="noopener">官方docker处理方式</a>,镜像体积缩小至167M。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">这种方式会报错与MySQLsocket通信异常...</span><br><span class="line">docker run -it --rm --link mysql5.6 -p 1111:11111 -p 1112:11112 -v `pwd`/canal-signle.properties:/canal/conf/canal.properties -v `pwd`/example:/canal/conf/example canal</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>参考官方脚本,精简后运行</p>
<ol>
<li>-e参数里可以指定以前canal.properties/instance.properties里的所有配置的key和value，canal-server启动时会有限读取-e指定的变量</li>
<li>有相关容器目录需要挂载出来,请自行挂载。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">bootstrap.sh</span><br><span class="line">    #!/bin/bash</span><br><span class="line">    current_path=`pwd`</span><br><span class="line">    case &quot;`uname`&quot; in</span><br><span class="line">        Linux)</span><br><span class="line">                    bin_abs_path=$(readlink -f $(dirname $0))</span><br><span class="line">                    ;;</span><br><span class="line">            *)</span><br><span class="line">                    bin_abs_path=`cd $(dirname $0); pwd`</span><br><span class="line">                    ;;</span><br><span class="line">    esac</span><br><span class="line">    if [ -z &quot;$JAVA&quot; ] ; then</span><br><span class="line">    JAVA=$(which java)</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    base=$&#123;bin_abs_path&#125;/..</span><br><span class="line">    canal_conf=$base/conf/canal.properties</span><br><span class="line">    logback_configurationFile=$base/conf/logback.xml</span><br><span class="line">    JAVA_OPTS=&quot;-server -Xms2048m -Xmx3072m -Xmn1024m -XX:SurvivorRatio=2 -XX:PermSize=96m -XX:MaxPermSize=256m -Xss256k -XX:-UseAdaptiveSizePolicy -XX:MaxTenuringThreshold=15 -XX:+DisableExplicitGC -XX:+UseConcMarkSweepGC -XX:+CMSParallelRemarkEnabled -XX:+UseCMSCompactAtFullCollection -XX:+UseFastAccessorMethods -XX:+UseCMSInitiatingOccupancyOnly -XX:+HeapDumpOnOutOfMemoryError&quot;</span><br><span class="line">    JAVA_OPTS=&quot; $JAVA_OPTS -Djava.awt.headless=true -Djava.net.preferIPv4Stack=true -Dfile.encoding=UTF-8&quot;</span><br><span class="line">    CANAL_OPTS=&quot;-DappName=otter-canal -Dlogback.configurationFile=$logback_configurationFile -Dcanal.conf=$canal_conf&quot;</span><br><span class="line"></span><br><span class="line">    for i in $base/lib/*;</span><br><span class="line">            do CLASSPATH=$i:&quot;$CLASSPATH&quot;;</span><br><span class="line">    done</span><br><span class="line">    CLASSPATH=&quot;$base/conf:$CLASSPATH&quot;;</span><br><span class="line">    exec $JAVA $JAVA_OPTS $CANAL_OPTS -classpath .:$CLASSPATH com.alibaba.otter.canal.deployer.CanalLauncher</span><br><span class="line"></span><br><span class="line">Dockerfile:</span><br><span class="line">    FROM alpine/jre8</span><br><span class="line">    MAINTAINER charles &quot;amwfhv@yeah.net&quot;</span><br><span class="line">    RUN apk add --no-cache \</span><br><span class="line">        bash \</span><br><span class="line">        su-exec</span><br><span class="line">    ADD canal.deployer-1.1.2.tar.gz /canal/</span><br><span class="line">    #ADD bootstrap.sh /canal/bin/</span><br><span class="line">    EXPOSE 11111 11112</span><br><span class="line">    #ENTRYPOINT [&quot;/canal/bin/bootstrap.sh&quot;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">运行:</span><br><span class="line">docker run -it \</span><br><span class="line">-e canal.zkServers=10.72.29.130:2181,10.72.29.130:2182,10.72.29.130:2183 \</span><br><span class="line">-e canal.auto.scan=false \</span><br><span class="line">-e canal.destinations=canal_test \</span><br><span class="line">-e canal.instance.master.address=10.72.29.130:3308 \</span><br><span class="line">-e canal.instance.dbUsername=canal \</span><br><span class="line">-e canal.instance.dbPassword=canal \</span><br><span class="line">-e canal.instance.connectionCharset=UTF-8 \</span><br><span class="line">-e canal.instance.tsdb.enable=true \</span><br><span class="line">-e canal.instance.gtidon=false \</span><br><span class="line">--name=canal_test -p 22222:11111 -p 22223:11112 canal</span><br><span class="line"></span><br><span class="line">运行后容器内会生成目录文件:</span><br><span class="line">    /conf/canal_test  即/conf/$&#123;canal.destinations&#125; 目录下有 h2.mv.db  meta.dat</span><br><span class="line">    /logs/canal/canal.log</span><br><span class="line">    /logs/canal_test/canal_test.log  /logs/canal_test/meta.log</span><br><span class="line"></span><br><span class="line">运行后在zk中查询数据</span><br><span class="line">    docker exec -it d355b93ad4a0 /zookeeper-3.4.13/bin/zkCli.sh</span><br><span class="line">    ls /otter/canal/cluster</span><br><span class="line">    [172.17.0.3:11111]</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>ZK + Canal 集群 docker-compose编排</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">文件目录 </span><br><span class="line">.</span><br><span class="line">├── canal</span><br><span class="line">│   ├── Dockerfile</span><br><span class="line">│   ├── bootstrap.sh </span><br><span class="line">│   ├── canal.deployer-1.1.2.tar.gz</span><br><span class="line">├── docker-compose.yml</span><br><span class="line">└── zk</span><br><span class="line">    ├── Dockerfile</span><br><span class="line">    ├── myid_1</span><br><span class="line">    ├── myid_2</span><br><span class="line">    ├── myid_3</span><br><span class="line">    ├── zoo.cfg</span><br><span class="line">    └── zookeeper-3.4.13.tar.gz</span><br><span class="line"></span><br><span class="line">docker-compose.yml</span><br><span class="line">version: &apos;2&apos;</span><br><span class="line">services:</span><br><span class="line">  zk1:</span><br><span class="line">    build:</span><br><span class="line">      context: ./zk</span><br><span class="line">      dockerfile: ./Dockerfile</span><br><span class="line">    container_name: zk1</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;2181:2181&quot;</span><br><span class="line">    networks:</span><br><span class="line">      canal-cluster:  # 使用canal-cluster网络</span><br><span class="line">        ipv4_address: 192.168.222.111   #固定容器IP为192.168.222.111</span><br><span class="line">    volumes:</span><br><span class="line">      - ./zk/zoo.cfg:/zookeeper-3.4.13/conf/zoo.cfg</span><br><span class="line">      - ./zk/myid_1:/zookeeper-3.4.13/data/myid</span><br><span class="line">  zk2:</span><br><span class="line">    build:</span><br><span class="line">      context: ./zk</span><br><span class="line">      dockerfile: ./Dockerfile</span><br><span class="line">    container_name: zk2</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;2182:2181&quot;</span><br><span class="line">    networks:</span><br><span class="line">      canal-cluster:  # 使用canal-cluster网络</span><br><span class="line">        ipv4_address: 192.168.222.112   #固定容器IP为192.168.222.112</span><br><span class="line">    volumes:</span><br><span class="line">      - ./zk/zoo.cfg:/zookeeper-3.4.13/conf/zoo.cfg</span><br><span class="line">      - ./zk/myid_2:/zookeeper-3.4.13/data/myid</span><br><span class="line">  zk3:</span><br><span class="line">    build:</span><br><span class="line">      context: ./zk</span><br><span class="line">      dockerfile: ./Dockerfile</span><br><span class="line">    container_name: zk3</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;2183:2181&quot;</span><br><span class="line">    networks:</span><br><span class="line">      canal-cluster:  # 使用canal-cluster网络</span><br><span class="line">        ipv4_address: 192.168.222.113   #固定容器IP为192.168.222.113</span><br><span class="line">    volumes:</span><br><span class="line">      - ./zk/zoo.cfg:/zookeeper-3.4.13/conf/zoo.cfg</span><br><span class="line">      - ./zk/myid_3:/zookeeper-3.4.13/data/myid</span><br><span class="line">  canal1:</span><br><span class="line">    build:</span><br><span class="line">      context: ./canal</span><br><span class="line">      dockerfile: ./Dockerfile</span><br><span class="line">    container_name: canal1</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;11111:11111&quot;</span><br><span class="line">      - &quot;11112:11112&quot;</span><br><span class="line">    depends_on:</span><br><span class="line">    - zk1</span><br><span class="line">    - zk2</span><br><span class="line">    - zk3 </span><br><span class="line">    networks:</span><br><span class="line">      canal-cluster:  # 使用canal-cluster网络</span><br><span class="line">        ipv4_address: 192.168.222.114   #固定容器IP为192.168.222.114</span><br><span class="line">    environment:</span><br><span class="line">      - canal.zkServers=zk1:2181,zk2:2181,zk3:2181</span><br><span class="line">      - canal.auto.scan=false</span><br><span class="line">      - canal.destinations=canal1</span><br><span class="line">      - canal.instance.master.address=10.72.29.130:3308</span><br><span class="line">      - canal.instance.dbUsername=canal</span><br><span class="line">      - canal.instance.dbPassword=canal</span><br><span class="line">      - canal.instance.connectionCharset=UTF-8</span><br><span class="line">      - canal.instance.tsdb.enable=true</span><br><span class="line">      - canal.instance.gtidon=false</span><br><span class="line"></span><br><span class="line">  canal2:</span><br><span class="line">    build:</span><br><span class="line">      context: ./canal</span><br><span class="line">      dockerfile: ./Dockerfile</span><br><span class="line">    container_name: canal2</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;11121:11111&quot;</span><br><span class="line">      - &quot;11122:11112&quot;</span><br><span class="line">    depends_on:</span><br><span class="line">    - zk1</span><br><span class="line">    - zk2</span><br><span class="line">    - zk3 </span><br><span class="line">    networks:</span><br><span class="line">      canal-cluster:  # 使用canal-cluster网络</span><br><span class="line">        ipv4_address: 192.168.222.115   #固定容器IP为192.168.222.115</span><br><span class="line">    environment:</span><br><span class="line">      - canal.zkServers=zk1:2181,zk2:2181,zk3:2181</span><br><span class="line">      - canal.auto.scan=false</span><br><span class="line">      - canal.destinations=canal2</span><br><span class="line">      - canal.instance.master.address=10.72.29.130:3308</span><br><span class="line">      - canal.instance.dbUsername=canal</span><br><span class="line">      - canal.instance.dbPassword=canal</span><br><span class="line">      - canal.instance.connectionCharset=UTF-8</span><br><span class="line">      - canal.instance.tsdb.enable=true</span><br><span class="line">      - canal.instance.gtidon=false</span><br><span class="line">networks:</span><br><span class="line">  canal-cluster:</span><br><span class="line">    driver: bridge</span><br><span class="line">    #   自定义网络信息</span><br><span class="line">    ipam:</span><br><span class="line">      driver: default</span><br><span class="line">      config:</span><br><span class="line">        - subnet: 192.168.222.0/24  # 子网段</span><br><span class="line">          gateway: 192.168.222.1    # 网关</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Canal监听binlog并发送至MQ"><a href="#Canal监听binlog并发送至MQ" class="headerlink" title="Canal监听binlog并发送至MQ"></a>Canal监听binlog并发送至MQ</h3><ul>
<li>canal 1.1.1版本之后, 默认支持将canal server接收到的binlog数据直接投递到MQ, 目前默认支持的MQ系统有:<ol>
<li><a href="https://github.com/apache/kafka" target="_blank" rel="noopener">Kafka</a></li>
<li><a href="https://github.com/apache/rocketmq" target="_blank" rel="noopener">RocketMQ</a></li>
<li><a href="https://github.com/alibaba/canal/wiki/Canal-Kafka-RocketMQ-QuickStart" target="_blank" rel="noopener">官方详细介绍</a></li>
</ol>
</li>
<li><p>单节点测试发送至MQ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">docker run -it \</span><br><span class="line">-e canal.serverMode=kafka \</span><br><span class="line">-e canal.mq.topic=canal_test \</span><br><span class="line">-e canal.mq.servers=10.72.8.91:9192,10.72.8.92:9192,10.72.8.93:9192 \</span><br><span class="line">-e canal.mq.flatMessage=true \</span><br><span class="line">-e canal.mq.acks=all \</span><br><span class="line">-e canal.auto.scan=false \</span><br><span class="line">-e canal.destinations=canal_test \</span><br><span class="line">-e canal.instance.master.address=10.72.29.130:3308 \</span><br><span class="line">-e canal.instance.dbUsername=canal \</span><br><span class="line">-e canal.instance.dbPassword=canal \</span><br><span class="line">-e canal.instance.connectionCharset=UTF-8 \</span><br><span class="line">-e canal.instance.tsdb.enable=true \</span><br><span class="line">-e canal.instance.gtidon=false \</span><br><span class="line">--name=canal_test -p 22222:11111 -p 22223:11112 canal</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">SQL:</span><br><span class="line">UPDATE `data-center`.`vb_credential` SET `app_acount` = &apos;vbim.test5&apos; WHERE id = 4</span><br><span class="line"></span><br><span class="line">Kafka监听到消息:</span><br><span class="line">&#123;</span><br><span class="line">    &quot;data&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;id&quot;: &quot;4&quot;,</span><br><span class="line">            &quot;app_account&quot;: &quot;vbim.test5&quot;,</span><br><span class="line">            &quot;app_key&quot;: &quot;F6F1EEC9C195B0F10AE74812A938EFBDD6561C4016B9B0F65FE224F921C09BDAC7B6A5E94CDDF10014C82938FC2ECACA&quot;,</span><br><span class="line">            &quot;app_secret&quot;: &quot;bjJlazVTT0M5MzBCYTBPUjQxMTRBblQ2OXRzTDM1NDA=&quot;,</span><br><span class="line">            &quot;type&quot;: &quot;1&quot;,</span><br><span class="line">            &quot;expire_time&quot;: &quot;2018-09-20 13:50:16&quot;,</span><br><span class="line">            &quot;last_auth_time&quot;: &quot;2018-09-20 13:47:16&quot;,</span><br><span class="line">            &quot;is_del&quot;: &quot;1&quot;,</span><br><span class="line">            &quot;creater_time&quot;: &quot;2018-09-19 16:09:03&quot;,</span><br><span class="line">            &quot;creater_id&quot;: null,</span><br><span class="line">            &quot;update_time&quot;: null,</span><br><span class="line">            &quot;update_id&quot;: null</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;database&quot;: &quot;data-center&quot;,</span><br><span class="line">    &quot;es&quot;: 1552620281000,</span><br><span class="line">    &quot;id&quot;: 2,</span><br><span class="line">    &quot;isDdl&quot;: false,</span><br><span class="line">    &quot;mysqlType&quot;: &#123;</span><br><span class="line">        &quot;id&quot;: &quot;bigint(20)&quot;,</span><br><span class="line">        &quot;app_account&quot;: &quot;varchar(64)&quot;,</span><br><span class="line">        &quot;app_key&quot;: &quot;varchar(255)&quot;,</span><br><span class="line">        &quot;app_secret&quot;: &quot;varchar(255)&quot;,</span><br><span class="line">        &quot;type&quot;: &quot;smallint(1)&quot;,</span><br><span class="line">        &quot;expire_time&quot;: &quot;datetime&quot;,</span><br><span class="line">        &quot;last_auth_time&quot;: &quot;datetime&quot;,</span><br><span class="line">        &quot;is_del&quot;: &quot;tinyint(1)&quot;,</span><br><span class="line">        &quot;creater_time&quot;: &quot;datetime&quot;,</span><br><span class="line">        &quot;creater_id&quot;: &quot;varchar(64)&quot;,</span><br><span class="line">        &quot;update_time&quot;: &quot;datetime&quot;,</span><br><span class="line">        &quot;update_id&quot;: &quot;varchar(64)&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;old&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;app_account&quot;: &quot;vbim.test4&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;sql&quot;: &quot;&quot;,</span><br><span class="line">    &quot;sqlType&quot;: &#123;</span><br><span class="line">        &quot;id&quot;: -5,</span><br><span class="line">        &quot;app_account&quot;: 12,</span><br><span class="line">        &quot;app_key&quot;: 12,</span><br><span class="line">        &quot;app_secret&quot;: 12,</span><br><span class="line">        &quot;type&quot;: 5,</span><br><span class="line">        &quot;expire_time&quot;: 93,</span><br><span class="line">        &quot;last_auth_time&quot;: 93,</span><br><span class="line">        &quot;is_del&quot;: -7,</span><br><span class="line">        &quot;creater_time&quot;: 93,</span><br><span class="line">        &quot;creater_id&quot;: 12,</span><br><span class="line">        &quot;update_time&quot;: 93,</span><br><span class="line">        &quot;update_id&quot;: 12</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;table&quot;: &quot;vb_credential&quot;,</span><br><span class="line">    &quot;ts&quot;: 1552620281658,</span><br><span class="line">    &quot;type&quot;: &quot;UPDATE&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Canal HA 服务编排</p>
<ol>
<li>Canal HA模式需要两个相同的节点instance name一样,挂掉后自动切换(官方描述:两台机器上的instance目录的名字需要保证完全一致，HA模式是依赖于instance name进行管理，同时必须都选择default-instance.xml配置)<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">version: &apos;2&apos;</span><br><span class="line">services:</span><br><span class="line">  zk1:</span><br><span class="line">    build:</span><br><span class="line">      context: ./zk</span><br><span class="line">      dockerfile: ./Dockerfile</span><br><span class="line">    container_name: zk1</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;2181:2181&quot;</span><br><span class="line">    networks:</span><br><span class="line">      canal-cluster:  # 使用canal-cluster网络</span><br><span class="line">        ipv4_address: 192.168.222.111   #固定容器IP为192.168.222.111</span><br><span class="line">    volumes:</span><br><span class="line">      - ./zk/zoo.cfg:/zookeeper-3.4.13/conf/zoo.cfg</span><br><span class="line">      - ./zk/myid_1:/zookeeper-3.4.13/data/myid</span><br><span class="line">  zk2:</span><br><span class="line">    build:</span><br><span class="line">      context: ./zk</span><br><span class="line">      dockerfile: ./Dockerfile</span><br><span class="line">    container_name: zk2</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;2182:2181&quot;</span><br><span class="line">    networks:</span><br><span class="line">      canal-cluster:  # 使用canal-cluster网络</span><br><span class="line">        ipv4_address: 192.168.222.112   #固定容器IP为192.168.222.112</span><br><span class="line">    volumes:</span><br><span class="line">      - ./zk/zoo.cfg:/zookeeper-3.4.13/conf/zoo.cfg</span><br><span class="line">      - ./zk/myid_2:/zookeeper-3.4.13/data/myid</span><br><span class="line">  zk3:</span><br><span class="line">    build:</span><br><span class="line">      context: ./zk</span><br><span class="line">      dockerfile: ./Dockerfile</span><br><span class="line">    container_name: zk3</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;2183:2181&quot;</span><br><span class="line">    networks:</span><br><span class="line">      canal-cluster:  # 使用canal-cluster网络</span><br><span class="line">        ipv4_address: 192.168.222.113   #固定容器IP为192.168.222.113</span><br><span class="line">    volumes:</span><br><span class="line">      - ./zk/zoo.cfg:/zookeeper-3.4.13/conf/zoo.cfg</span><br><span class="line">      - ./zk/myid_3:/zookeeper-3.4.13/data/myid</span><br><span class="line">  canal1:</span><br><span class="line">    build:</span><br><span class="line">      context: ./canal</span><br><span class="line">      dockerfile: ./Dockerfile</span><br><span class="line">    container_name: canal1</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;11111:11111&quot;</span><br><span class="line">      - &quot;11112:11112&quot;</span><br><span class="line">    depends_on:</span><br><span class="line">      - zk1</span><br><span class="line">      - zk2</span><br><span class="line">      - zk3</span><br><span class="line">    networks:</span><br><span class="line">      canal-cluster:  # 使用canal-cluster网络</span><br><span class="line">        ipv4_address: 192.168.222.114   #固定容器IP为192.168.222.114</span><br><span class="line">    environment:</span><br><span class="line">      - canal.serverMode=kafka</span><br><span class="line">      - canal.mq.topic=canal_test</span><br><span class="line">      - canal.mq.servers=10.72.8.91:9192,10.72.8.92:9192,10.72.8.93:9192</span><br><span class="line">      - canal.mq.flatMessage=true</span><br><span class="line">      - canal.mq.acks=all</span><br><span class="line">      - canal.zkServers=zk1:2181,zk2:2181,zk3:2181</span><br><span class="line">      - canal.auto.scan=false</span><br><span class="line">      - canal.destinations=canal</span><br><span class="line">      - canal.instance.master.address=10.72.29.130:3308</span><br><span class="line">      - canal.instance.dbUsername=canal</span><br><span class="line">      - canal.instance.dbPassword=canal</span><br><span class="line">      - canal.instance.connectionCharset=UTF-8</span><br><span class="line">      - canal.instance.tsdb.enable=true</span><br><span class="line">      - canal.instance.gtidon=false</span><br><span class="line"></span><br><span class="line">  canal2:</span><br><span class="line">    build:</span><br><span class="line">      context: ./canal</span><br><span class="line">      dockerfile: ./Dockerfile</span><br><span class="line">    container_name: canal2</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;11121:11111&quot;</span><br><span class="line">      - &quot;11122:11112&quot;</span><br><span class="line">    depends_on:</span><br><span class="line">      - zk1</span><br><span class="line">      - zk2</span><br><span class="line">      - zk3</span><br><span class="line">    networks:</span><br><span class="line">      canal-cluster:  # 使用canal-cluster网络</span><br><span class="line">        ipv4_address: 192.168.222.115   #固定容器IP为192.168.222.115</span><br><span class="line">    environment:</span><br><span class="line">      - canal.serverMode=kafka</span><br><span class="line">      - canal.mq.topic=canal_test</span><br><span class="line">      - canal.mq.servers=10.72.8.91:9192,10.72.8.92:9192,10.72.8.93:9192</span><br><span class="line">      - canal.mq.flatMessage=true</span><br><span class="line">      - canal.mq.acks=all</span><br><span class="line">      - canal.zkServers=zk1:2181,zk2:2181,zk3:2181</span><br><span class="line">      - canal.auto.scan=false</span><br><span class="line">      - canal.destinations=canal</span><br><span class="line">      - canal.instance.master.address=10.72.29.130:3308</span><br><span class="line">      - canal.instance.dbUsername=canal</span><br><span class="line">      - canal.instance.dbPassword=canal</span><br><span class="line">      - canal.instance.connectionCharset=UTF-8</span><br><span class="line">      - canal.instance.tsdb.enable=true</span><br><span class="line">      - canal.instance.gtidon=false</span><br><span class="line">networks:</span><br><span class="line">  canal-cluster:</span><br><span class="line">    driver: bridge</span><br><span class="line">    #   自定义网络信息</span><br><span class="line">    ipam:</span><br><span class="line">      driver: default</span><br><span class="line">      config:</span><br><span class="line">        - subnet: 192.168.222.0/24  # 子网段</span><br><span class="line">          gateway: 192.168.222.1    # 网关</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ul>
<h3 id="SpringBoot监听程序"><a href="#SpringBoot监听程序" class="headerlink" title="SpringBoot监听程序"></a>SpringBoot监听程序</h3><ul>
<li><p>Dockerfile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FROM alpine/jre8</span><br><span class="line">MAINTAINER charles &quot;amwfhv@yeah.net&quot;</span><br><span class="line">ADD target/spring-cloud-stream.jar /opt/spring-cloud-stream.jar</span><br><span class="line">ENTRYPOINT [&quot;java&quot; ,&quot;-jar&quot;,&quot;-Dspring.profiles.active=docker&quot;,&quot;/opt/spring-cloud-stream.jar&quot;]</span><br></pre></td></tr></table></figure>
</li>
<li><p>pom.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br><span class="line">         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;charles.org&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-stream&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span><br><span class="line"></span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.0.1.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class="line">        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;</span><br><span class="line">        &lt;java.version&gt;1.8&lt;/java.version&gt;</span><br><span class="line">        &lt;spring-cloud.version&gt;Finchley.M9&lt;/spring-cloud.version&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">    &lt;repositories&gt;</span><br><span class="line">        &lt;repository&gt;</span><br><span class="line">            &lt;id&gt;spring-milestones&lt;/id&gt;</span><br><span class="line">            &lt;name&gt;Spring Milestones&lt;/name&gt;</span><br><span class="line">            &lt;url&gt;https://repo.spring.io/milestone&lt;/url&gt;</span><br><span class="line">            &lt;snapshots&gt;</span><br><span class="line">                &lt;enabled&gt;false&lt;/enabled&gt;</span><br><span class="line">            &lt;/snapshots&gt;</span><br><span class="line">        &lt;/repository&gt;</span><br><span class="line">    &lt;/repositories&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencyManagement&gt;</span><br><span class="line">        &lt;dependencies&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;$&#123;spring-cloud.version&#125;&lt;/version&gt;</span><br><span class="line">                &lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">                &lt;scope&gt;import&lt;/scope&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">        &lt;/dependencies&gt;</span><br><span class="line">    &lt;/dependencyManagement&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-stream-binder-kafka&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.0.1.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;finalName&gt;$&#123;project.artifactId&#125;&lt;/finalName&gt;</span><br><span class="line">        &lt;resources&gt;</span><br><span class="line">            &lt;resource&gt;</span><br><span class="line">                &lt;directory&gt;src/main/java&lt;/directory&gt;</span><br><span class="line">                &lt;includes&gt;</span><br><span class="line">                    &lt;include&gt;**/*.properties&lt;/include&gt;</span><br><span class="line">                    &lt;include&gt;**/*.xml&lt;/include&gt;</span><br><span class="line">                    &lt;include&gt;**/*.yml&lt;/include&gt;</span><br><span class="line">                &lt;/includes&gt;</span><br><span class="line">                &lt;filtering&gt;false&lt;/filtering&gt;</span><br><span class="line">            &lt;/resource&gt;</span><br><span class="line">            &lt;resource&gt;</span><br><span class="line">                &lt;directory&gt;src/main/resources&lt;/directory&gt;</span><br><span class="line">                &lt;includes&gt;</span><br><span class="line">                    &lt;include&gt;**/*.*&lt;/include&gt;</span><br><span class="line">                &lt;/includes&gt;</span><br><span class="line">                &lt;filtering&gt;false&lt;/filtering&gt;</span><br><span class="line">            &lt;/resource&gt;</span><br><span class="line">        &lt;/resources&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;2.0.1.RELEASE&lt;/version&gt;</span><br><span class="line">                &lt;executions&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;repackage&lt;/goal&gt;</span><br><span class="line">                        &lt;/goals&gt;</span><br><span class="line">                    &lt;/execution&gt;</span><br><span class="line">                &lt;/executions&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;layout&gt;JAR&lt;/layout&gt;</span><br><span class="line">                &lt;/configuration&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>application.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 7890</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: canal_mq_consumer</span><br><span class="line">  cloud:</span><br><span class="line">    stream:</span><br><span class="line">      kafka:</span><br><span class="line">        binder:</span><br><span class="line">          brokers: kafka1:9092,kafka2:9092,kafka3:9092</span><br><span class="line">      default-binder: kafka</span><br><span class="line">      bindings:</span><br><span class="line">        canal_test:</span><br><span class="line">          destination: canal_test</span><br><span class="line">          group: canal_test_group</span><br><span class="line">          partitioned: false</span><br><span class="line">          content-type: application/json</span><br></pre></td></tr></table></figure>
</li>
<li><p>java代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">package charles.org.stream.receive;</span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line">import org.springframework.cloud.stream.annotation.EnableBinding;</span><br><span class="line">import org.springframework.cloud.stream.annotation.StreamListener;</span><br><span class="line">import org.springframework.cloud.stream.messaging.Sink;</span><br><span class="line"></span><br><span class="line">@EnableBinding(Sink.class)</span><br><span class="line">public class ReceiveService &#123;</span><br><span class="line">    private static final Logger logger = LoggerFactory.getLogger(ReceiveService.class);</span><br><span class="line"></span><br><span class="line">    @StreamListener(&quot;canal_test&quot;)</span><br><span class="line">    public void receive(String payload) &#123;</span><br><span class="line">        logger.info(&quot;接收到消息 &#123;&#125;&quot;, payload);</span><br><span class="line">//        logger.info(&quot;接收到消息 &#123;&#125;&quot;, new String((byte[])payload));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">package charles.org.stream.receive;</span><br><span class="line">import org.springframework.boot.SpringApplication;</span><br><span class="line">import org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line">import org.springframework.cloud.stream.annotation.EnableBinding;</span><br><span class="line"></span><br><span class="line">@EnableBinding(StreamBinders.class)</span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class StreamApplication &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(StreamApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">package charles.org.stream.receive;</span><br><span class="line">import org.springframework.cloud.stream.annotation.Input;</span><br><span class="line">import org.springframework.messaging.SubscribableChannel;</span><br><span class="line"></span><br><span class="line">public interface StreamBinders &#123;</span><br><span class="line">    @Input(&quot;canal_test&quot;)</span><br><span class="line">    SubscribableChannel canalTest();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="附-Kafka-Docker器群"><a href="#附-Kafka-Docker器群" class="headerlink" title="(附) Kafka Docker器群"></a>(附) Kafka Docker器群</h3><ul>
<li>使用自定义网络,由于Kafka固定IP的需求,固定所有在编排的容器IP</li>
<li><p>下载kafka</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -O http://mirrors.shu.edu.cn/apache/kafka/2.1.1/kafka_2.12-2.1.1.tgz</span><br></pre></td></tr></table></figure>
</li>
<li><p>server.properties</p>
<ol>
<li><code>listeners</code> <font color="red">一定要配置成为IP地址；</font> 如果配置为localhost或服务器的hostname,在使用java发送数据时就会抛出异常：<code>org.apache.kafka.common.errors.TimeoutException: Batch Expired</code>。因为在没有配置<code>advertised.host.name</code> 的情况下，Kafka并没有像官方文档宣称的那样改为广播我们配置的<code>host.name</code>，而是广播了主机配置的hostname。远端的客户端并没有配置 hosts，所以自然是连接不上这个hostname的</li>
</ol>
</li>
<li><p>node1 配置<code>server1.properties</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">broker.id=1</span><br><span class="line">listeners=PLAINTEXT://192.168.111.115:9092</span><br><span class="line">advertised.listeners=PLAINTEXT://192.168.111.115:9092</span><br><span class="line">num.network.threads=3</span><br><span class="line">num.io.threads=8</span><br><span class="line">socket.send.buffer.bytes=102400</span><br><span class="line">socket.receive.buffer.bytes=102400</span><br><span class="line">socket.request.max.bytes=104857600</span><br><span class="line">log.dirs=/opt/kafka/logs</span><br><span class="line">num.partitions=1</span><br><span class="line">num.recovery.threads.per.data.dir=1</span><br><span class="line">delete.topic.enable=true</span><br><span class="line">offsets.topic.replication.factor=1</span><br><span class="line">transaction.state.log.replication.factor=1</span><br><span class="line">transaction.state.log.min.isr=1</span><br><span class="line">log.retention.hours=168</span><br><span class="line">log.segment.bytes=1073741824</span><br><span class="line">log.retention.check.interval.ms=300000</span><br><span class="line">log.cleaner.enable=true</span><br><span class="line">#zookeeper.connect=192.168.111.111:2181,192.168.111.112:2181,192.168.111.113:2181</span><br><span class="line">zookeeper.connect=zk1:2181,zk2:2181,zk3:2181</span><br><span class="line">zookeeper.connection.timeout.ms=6000</span><br><span class="line">group.initial.rebalance.delay.ms=0</span><br><span class="line">auto.leader.rebalance.enable=true</span><br><span class="line">inter.broker.protocol.version=1.1.1</span><br><span class="line">log.message.format.version=1.1.1</span><br></pre></td></tr></table></figure>
</li>
<li><p>node2 配置<code>server2.properties</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">broker.id=2</span><br><span class="line">listeners=PLAINTEXT://192.168.111.116:9092</span><br><span class="line">advertised.listeners=PLAINTEXT://192.168.111.116:9092</span><br><span class="line">num.network.threads=3</span><br><span class="line">num.io.threads=8</span><br><span class="line">socket.send.buffer.bytes=102400</span><br><span class="line">socket.receive.buffer.bytes=102400</span><br><span class="line">socket.request.max.bytes=104857600</span><br><span class="line">log.dirs=/opt/kafka/logs</span><br><span class="line">num.partitions=1</span><br><span class="line">num.recovery.threads.per.data.dir=1</span><br><span class="line">delete.topic.enable=true</span><br><span class="line">offsets.topic.replication.factor=1</span><br><span class="line">transaction.state.log.replication.factor=1</span><br><span class="line">transaction.state.log.min.isr=1</span><br><span class="line">log.retention.hours=168</span><br><span class="line">log.segment.bytes=1073741824</span><br><span class="line">log.retention.check.interval.ms=300000</span><br><span class="line">log.cleaner.enable=true</span><br><span class="line">#zookeeper.connect=192.168.111.111:2181,192.168.111.112:2181,192.168.111.113:2181</span><br><span class="line">zookeeper.connect=zk1:2181,zk2:2181,zk3:2181</span><br><span class="line">zookeeper.connection.timeout.ms=6000</span><br><span class="line">group.initial.rebalance.delay.ms=0</span><br><span class="line">auto.leader.rebalance.enable=true</span><br><span class="line">inter.broker.protocol.version=1.1.1</span><br><span class="line">log.message.format.version=1.1.1</span><br></pre></td></tr></table></figure>
</li>
<li><p>node3 配置<code>server3.properties</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">broker.id=3</span><br><span class="line">listeners=PLAINTEXT://192.168.111.117:9092</span><br><span class="line">advertised.listeners=PLAINTEXT://192.168.111.117:9092</span><br><span class="line">num.network.threads=3</span><br><span class="line">num.io.threads=8</span><br><span class="line">socket.send.buffer.bytes=102400</span><br><span class="line">socket.receive.buffer.bytes=102400</span><br><span class="line">socket.request.max.bytes=104857600</span><br><span class="line">log.dirs=/opt/kafka/logs</span><br><span class="line">num.partitions=1</span><br><span class="line">num.recovery.threads.per.data.dir=1</span><br><span class="line">delete.topic.enable=true</span><br><span class="line">offsets.topic.replication.factor=1</span><br><span class="line">transaction.state.log.replication.factor=1</span><br><span class="line">transaction.state.log.min.isr=1</span><br><span class="line">log.retention.hours=168</span><br><span class="line">log.segment.bytes=1073741824</span><br><span class="line">log.retention.check.interval.ms=300000</span><br><span class="line">log.cleaner.enable=true</span><br><span class="line">#zookeeper.connect=192.168.111.111:2181,192.168.111.112:2181,192.168.111.113:2181</span><br><span class="line">zookeeper.connect=zk1:2181,zk2:2181,zk3:2181</span><br><span class="line">zookeeper.connection.timeout.ms=6000</span><br><span class="line">group.initial.rebalance.delay.ms=0</span><br><span class="line">auto.leader.rebalance.enable=true</span><br><span class="line">inter.broker.protocol.version=1.1.1</span><br><span class="line">log.message.format.version=1.1.1</span><br></pre></td></tr></table></figure>
</li>
<li><p>kafka集群编排</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">version: &apos;2&apos;</span><br><span class="line">services:</span><br><span class="line">  zk1:</span><br><span class="line">    build:</span><br><span class="line">      context: ./zk</span><br><span class="line">      dockerfile: ./Dockerfile</span><br><span class="line">    container_name: zk1</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;2181:2181&quot;</span><br><span class="line">    networks:</span><br><span class="line">      kafka-cluster:  # 使用kafka-cluster网络</span><br><span class="line">        ipv4_address: 192.168.111.111   #固定容器IP为192.168.111.111</span><br><span class="line">    volumes:</span><br><span class="line">      - ./zk/zoo.cfg:/zookeeper-3.4.13/conf/zoo.cfg</span><br><span class="line">      - ./zk/myid_1:/zookeeper-3.4.13/data/myid</span><br><span class="line">  zk2:</span><br><span class="line">    build:</span><br><span class="line">      context: ./zk</span><br><span class="line">      dockerfile: ./Dockerfile</span><br><span class="line">    container_name: zk2</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;2182:2181&quot;</span><br><span class="line">    networks:</span><br><span class="line">      kafka-cluster:  # 使用kafka-cluster网络</span><br><span class="line">        ipv4_address: 192.168.111.112   #固定容器IP为192.168.111.112</span><br><span class="line">    volumes:</span><br><span class="line">      - ./zk/zoo.cfg:/zookeeper-3.4.13/conf/zoo.cfg</span><br><span class="line">      - ./zk/myid_2:/zookeeper-3.4.13/data/myid</span><br><span class="line">  zk3:</span><br><span class="line">    build:</span><br><span class="line">      context: ./zk</span><br><span class="line">      dockerfile: ./Dockerfile</span><br><span class="line">    container_name: zk3</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;2183:2181&quot;</span><br><span class="line">    networks:</span><br><span class="line">      kafka-cluster:  # 使用kafka-cluster网络</span><br><span class="line">        ipv4_address: 192.168.111.113   #固定容器IP为192.168.111.113</span><br><span class="line">    volumes:</span><br><span class="line">      - ./zk/zoo.cfg:/zookeeper-3.4.13/conf/zoo.cfg</span><br><span class="line">      - ./zk/myid_3:/zookeeper-3.4.13/data/myid</span><br><span class="line"></span><br><span class="line">  kafka1:</span><br><span class="line">    build:</span><br><span class="line">      context: ./kafka</span><br><span class="line">      dockerfile: ./Dockerfile</span><br><span class="line">    container_name: kafka1</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;9092:9092&quot;</span><br><span class="line">    networks:</span><br><span class="line">      kafka-cluster:  # 使用kafka-cluster网络</span><br><span class="line">        ipv4_address: 192.168.111.115   #固定容器IP为192.168.111.115</span><br><span class="line">    volumes:</span><br><span class="line">      - ./kafka/server1.properties:/kafka_2.12-2.1.1/config/server.properties</span><br><span class="line"></span><br><span class="line">  kafka2:</span><br><span class="line">    build:</span><br><span class="line">      context: ./kafka</span><br><span class="line">      dockerfile: ./Dockerfile</span><br><span class="line">    container_name: kafka2</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;9192:9092&quot;</span><br><span class="line">    networks:</span><br><span class="line">      kafka-cluster:  # 使用kafka-cluster网络</span><br><span class="line">        ipv4_address: 192.168.111.116   #固定容器IP为192.168.111.116</span><br><span class="line">    volumes:</span><br><span class="line">      - ./kafka/server2.properties:/kafka_2.12-2.1.1/config/server.properties</span><br><span class="line"></span><br><span class="line">  kafka3:</span><br><span class="line">    build:</span><br><span class="line">      context: ./kafka</span><br><span class="line">      dockerfile: ./Dockerfile</span><br><span class="line">    container_name: kafka3</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;9292:9092&quot;</span><br><span class="line">    networks:</span><br><span class="line">      kafka-cluster:  # 使用kafka-cluster网络</span><br><span class="line">        ipv4_address: 192.168.111.117   #固定容器IP为192.168.111.117</span><br><span class="line">    volumes:</span><br><span class="line">      - ./kafka/server3.properties:/kafka_2.12-2.1.1/config/server.properties</span><br><span class="line">networks:</span><br><span class="line">  kafka-cluster:</span><br><span class="line">    driver: bridge</span><br><span class="line">    #   自定义网络信息</span><br><span class="line">    ipam:</span><br><span class="line">      driver: default</span><br><span class="line">      config:</span><br><span class="line">        - subnet: 192.168.111.0/24  # 子网段</span><br><span class="line">          gateway: 192.168.111.1    # 网关</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">1.创建topic</span><br><span class="line">docker exec -it dc730ee4db89 /kafka_2.12-2.1.1/bin/kafka-topics.sh --create --zookeeper zk1:2181 --replication-factor 2 --partitions 1 --topic charles_tpoic</span><br><span class="line">WARNING: Due to limitations in metric names, topics with a period (&apos;.&apos;) or underscore (&apos;_&apos;) could collide. To avoid issues it is best to use either, but not both.</span><br><span class="line">Created topic &quot;charles_tpoic&quot;.</span><br><span class="line"></span><br><span class="line">2.查看topic列表</span><br><span class="line">docker exec -it dc730ee4db89 /kafka_2.12-2.1.1/bin/kafka-topics.sh --list --zookeeper zk1:2181</span><br><span class="line">charles_tpoic</span><br><span class="line"></span><br><span class="line">3.查看topic状态</span><br><span class="line">docker exec -it dc730ee4db89 /kafka_2.12-2.1.1/bin/kafka-topics.sh --describe --zookeeper zk1:2181 --topic charles_tpoic</span><br><span class="line">Topic:charles_tpoic	PartitionCount:1	ReplicationFactor:2	Configs:</span><br><span class="line">	Topic: charles_tpoic	Partition: 0	Leader: 3	Replicas: 3,1	Isr: 3,1</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="完整编排文件"><a href="#完整编排文件" class="headerlink" title="完整编排文件"></a>完整编排文件</h3><ul>
<li>使用外部kafka,MySQL,在编排中去除<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">version: &apos;2&apos;</span><br><span class="line">services:</span><br><span class="line">  zk1:</span><br><span class="line">    build:</span><br><span class="line">      context: ./zk</span><br><span class="line">      dockerfile: ./Dockerfile</span><br><span class="line">    container_name: zk1</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;2181:2181&quot;</span><br><span class="line">    networks:</span><br><span class="line">      - canal-cluster</span><br><span class="line">    volumes:</span><br><span class="line">      - ./zk/zoo.cfg:/zookeeper-3.4.13/conf/zoo.cfg</span><br><span class="line">      - ./zk/myid_1:/zookeeper-3.4.13/data/myid</span><br><span class="line">  zk2:</span><br><span class="line">    build:</span><br><span class="line">      context: ./zk</span><br><span class="line">      dockerfile: ./Dockerfile</span><br><span class="line">    container_name: zk2</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;2182:2181&quot;</span><br><span class="line">    networks:</span><br><span class="line">      - canal-cluster </span><br><span class="line">    volumes:</span><br><span class="line">      - ./zk/zoo.cfg:/zookeeper-3.4.13/conf/zoo.cfg</span><br><span class="line">      - ./zk/myid_2:/zookeeper-3.4.13/data/myid</span><br><span class="line">  zk3:</span><br><span class="line">    build:</span><br><span class="line">      context: ./zk</span><br><span class="line">      dockerfile: ./Dockerfile</span><br><span class="line">    container_name: zk3</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;2183:2181&quot;</span><br><span class="line">    networks:</span><br><span class="line">      - canal-cluster</span><br><span class="line">    volumes:</span><br><span class="line">      - ./zk/zoo.cfg:/zookeeper-3.4.13/conf/zoo.cfg</span><br><span class="line">      - ./zk/myid_3:/zookeeper-3.4.13/data/myid</span><br><span class="line">  </span><br><span class="line">  canal1:</span><br><span class="line">    build:</span><br><span class="line">      context: ./canal</span><br><span class="line">      dockerfile: ./Dockerfile</span><br><span class="line">    container_name: canal1</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;11111:11111&quot;</span><br><span class="line">      - &quot;11112:11112&quot;</span><br><span class="line">    depends_on:</span><br><span class="line">      - zk1</span><br><span class="line">      - zk2</span><br><span class="line">      - zk3</span><br><span class="line">    networks:</span><br><span class="line">      - canal-cluster</span><br><span class="line">    environment:</span><br><span class="line">      - canal.serverMode=kafka</span><br><span class="line">      - canal.mq.topic=canal_test</span><br><span class="line">      - canal.mq.servers=10.72.8.91:9192,10.72.8.92:9192,10.72.8.93:9192</span><br><span class="line">      - canal.mq.flatMessage=true</span><br><span class="line">      - canal.mq.acks=all</span><br><span class="line">      - canal.zkServers=zk1:2181,zk2:2181,zk3:2181</span><br><span class="line">      - canal.auto.scan=false</span><br><span class="line">      - canal.destinations=canal</span><br><span class="line">      - canal.instance.master.address=10.72.29.130:3308</span><br><span class="line">      - canal.instance.dbUsername=canal</span><br><span class="line">      - canal.instance.dbPassword=canal</span><br><span class="line">      - canal.instance.connectionCharset=UTF-8</span><br><span class="line">      - canal.instance.tsdb.enable=true</span><br><span class="line">      - canal.instance.gtidon=false</span><br><span class="line"></span><br><span class="line">  canal2:</span><br><span class="line">    build:</span><br><span class="line">      context: ./canal</span><br><span class="line">      dockerfile: ./Dockerfile</span><br><span class="line">    container_name: canal2</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;11121:11111&quot;</span><br><span class="line">      - &quot;11122:11112&quot;</span><br><span class="line">    depends_on:</span><br><span class="line">      - zk1</span><br><span class="line">      - zk2</span><br><span class="line">      - zk3</span><br><span class="line">    networks:</span><br><span class="line">      - canal-cluster</span><br><span class="line">    environment:</span><br><span class="line">      - canal.serverMode=kafka</span><br><span class="line">      - canal.mq.topic=canal_test</span><br><span class="line">      - canal.mq.servers=10.72.8.91:9192,10.72.8.92:9192,10.72.8.93:9192</span><br><span class="line">      - canal.mq.flatMessage=true</span><br><span class="line">      - canal.mq.acks=all</span><br><span class="line">      - canal.zkServers=zk1:2181,zk2:2181,zk3:2181</span><br><span class="line">      - canal.auto.scan=false</span><br><span class="line">      - canal.destinations=canal</span><br><span class="line">      - canal.instance.master.address=10.72.29.130:3308</span><br><span class="line">      - canal.instance.dbUsername=canal</span><br><span class="line">      - canal.instance.dbPassword=canal</span><br><span class="line">      - canal.instance.connectionCharset=UTF-8</span><br><span class="line">      - canal.instance.tsdb.enable=true</span><br><span class="line">      - canal.instance.gtidon=false</span><br><span class="line"></span><br><span class="line">  mq-consumer:</span><br><span class="line">    build:</span><br><span class="line">      context: ./spring-cloud-stream</span><br><span class="line">      dockerfile: ./Dockerfile</span><br><span class="line">    container_name: mq_consumer</span><br><span class="line">    depends_on:</span><br><span class="line">      - zk1</span><br><span class="line">      - zk2</span><br><span class="line">      - zk3</span><br><span class="line">      - canal1</span><br><span class="line">      - canal2</span><br><span class="line">    networks:</span><br><span class="line">      - canal-cluster</span><br><span class="line">networks:</span><br><span class="line">  canal-cluster:</span><br><span class="line">    driver: bridge</span><br></pre></td></tr></table></figure></li>
</ul>
</div><div class="tags"><a href="/tags/Java/">Java</a><a href="/tags/MySQL/">MySQL</a><a href="/tags/Kafka/">Kafka</a><a href="/tags/Docker/">Docker</a><a href="/tags/Canal/">Canal</a></div><div class="post-nav"><a class="next" href="/2019/03/12/MaxWell与Canal/">MaxWell与Canal</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'P3HSH58by4CLzdd1RAww5y5y-gzGzoHsz',
  appKey:'wAzBXy1KkhP1p1HnQb6OS86v',
  placeholder:'',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://charles1503.gitee.io"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/DevOps/">DevOps</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/banner/">banner</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/中间件/">中间件</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/微服务/">微服务</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/Dokcer/" style="font-size: 15px;">Dokcer</a> <a href="/tags/找乐子/" style="font-size: 15px;">找乐子</a> <a href="/tags/Lua/" style="font-size: 15px;">Lua</a> <a href="/tags/Kafka/" style="font-size: 15px;">Kafka</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/Canal/" style="font-size: 15px;">Canal</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/03/13/Docker构建Canal集群/">Docker构建Canal集群</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/12/MaxWell与Canal/">MaxWell与Canal</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/12/OpenResty之共享内存/">OpenResty ngx.shared.DICT</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/12/Consul和Consul Template的使用/">Consul和Consul Template使用笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/12/MySQL docker主从搭建/">使用docker搭建主从MySQL环境</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/12/banner-keyborad/">键盘Banner</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://gitee.com/charles1503" title="码云" target="_blank">码云</a><ul></ul><a href="https://github.com/charles1503" title="GitHub" target="_blank">GitHub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">Charles's Blog.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>